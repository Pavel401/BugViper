
from deepagent.config import config
from deepagent.models.agent_schemas import ContextData, Issue, ReconciledReview


def _severity_emoji(severity: str) -> str:
    return {"critical": "ğŸ”´", "high": "ğŸŸ ", "medium": "ğŸŸ¡", "low": "ğŸŸ¢"}.get(severity, "âšª")


def _render_issue(issue: Issue) -> list[str]:
    lines = [
        f"- {_severity_emoji(issue.severity)} **[{issue.category}] {issue.title}**"
        f" â€” `{issue.file}`:{issue.line_start}",
        f"  {issue.description}",
    ]
    if issue.suggestion:
        lines.append(f"  **Fix**: {issue.suggestion}")
    return lines


def format_github_comment(
    review: ReconciledReview,
    context: ContextData | None,
    pr_number: int,
) -> str:
    """Format a ReconciledReview + ContextData into a structured GitHub comment."""
    parts: list[str] = []

    # â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    parts.append("## ğŸ BugViper AI Code Review")
    parts.append("")
    parts.append(f"**PR**: #{pr_number} | **Model**: {config.review_model}")
    parts.append("")
    parts.append(f"**{review.summary}**")
    parts.append("")
    parts.append("---")
    parts.append("")

    # â”€â”€ Impact analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if context:
        risk_emoji = {"low": "ğŸŸ¢", "medium": "ğŸŸ¡", "high": "ğŸ”´"}.get(context.risk_level, "âšª")
        parts.append("### ğŸ“Š Impact Analysis")
        parts.append("")
        parts.append(f"- **Symbols modified**: {len(context.modified_symbols)}")
        parts.append(f"- **Downstream callers**: {context.total_callers}")
        parts.append(f"- **Risk level**: {risk_emoji} {context.risk_level.upper()}")
        parts.append("")
        parts.append("---")
        parts.append("")

    # Bucket issues by status
    fixed_issues   = [i for i in review.issues if i.status == "fixed"]
    open_issues    = [i for i in review.issues if i.status == "still_open"]
    new_issues     = [i for i in review.issues if i.status == "new"]

    # â”€â”€ Fixed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if fixed_issues:
        parts.append("### âœ… Fixed Since Last Review")
        parts.append("")
        for issue in fixed_issues:
            parts.append(f"- ~~**{issue.title}**~~ in `{issue.file}` â€” resolved")
        parts.append("")

    # â”€â”€ Still open â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if open_issues:
        parts.append("### ğŸ” Still Open")
        parts.append("")
        for issue in open_issues:
            for line in _render_issue(issue):
                parts.append(line)
        parts.append("")

    # â”€â”€ New issues â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if new_issues:
        parts.append("### ğŸ†• New Issues This Run")
        parts.append("")
        critical = [i for i in new_issues if i.severity == "critical"]
        high     = [i for i in new_issues if i.severity == "high"]
        medium   = [i for i in new_issues if i.severity == "medium"]
        low      = [i for i in new_issues if i.severity == "low"]

        for group_label, group in [
            ("ğŸ”´ Critical", critical),
            ("ğŸŸ  High", high),
            ("ğŸŸ¡ Medium", medium),
            ("ğŸŸ¢ Low", low),
        ]:
            if group:
                parts.append(f"#### {group_label}")
                for issue in group:
                    for line in _render_issue(issue):
                        parts.append(line)
                parts.append("")

    if not fixed_issues and not open_issues and not new_issues:
        parts.append("âœ… **No issues found!**")
        parts.append("")

    # â”€â”€ Positive findings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if review.positive_findings:
        parts.append("### ğŸ‘ Positive Findings")
        for finding in review.positive_findings:
            parts.append(f"- {finding}")
        parts.append("")

    # â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    parts.append("---")
    parts.append("")
    parts.append(f"*ğŸ¤– Generated by BugViper | Powered by {config.review_model}*")

    return "\n".join(parts)
